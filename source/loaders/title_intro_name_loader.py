from entity.type_finder import find_type_list
from loaders.document_loader import get_document
from loaders.mention_entity_loader import get_entities
from loaders.wiki_intro_loader import get_title_intro
from utilities.nlp_utils import recognize_mentions_in_batch, split_sentences_in_batch, clean_name, split_sentences, \
    possible_name_match, typical_name, get_text_with_fullname

name_loader = dict()
doc_intro_loader = dict()


def create_document_intro_list(document_list):
    doc_id_list = list()
    title_list = list()
    content_list = list()
    for news in document_list:
        parts = news.split("\t")
        doc_id_list.append(parts[0])
        title_list.append(parts[3])
        content_list.append(parts[4])
    intro_list = list()
    sentences_in_batch = split_sentences_in_batch(content_list)
    for sentences_in_the_same_document in sentences_in_batch:
        size = min(5, len(sentences_in_the_same_document))
        doc_intro = " ".join(sentences_in_the_same_document[:size])
        intro_list.append(doc_intro)
    return doc_id_list, title_list, intro_list


def add_names(document_list):
    doc_id_list, title_list, intro_list = create_document_intro_list(document_list)
    names_per_doc_intro_list = recognize_mentions_in_batch(intro_list)
    for i in range(len(doc_id_list)):
        doc_id = doc_id_list[i]
        names_in_current_doc_intro = [clean_name(name_obj.text.strip()) for name_obj in names_per_doc_intro_list[i]]
        if doc_id.startswith("wiki_"):
            title = title_list[i]
            if " (" in title:
                title = title[:title.index(" (")]
            names_in_current_doc_intro.append(title)
        for name in names_in_current_doc_intro:
            if " " in name:
                name_parts = name.split(" ")
                for name_part in name_parts:
                    name_loader[doc_id + "\t" + name_part] = name
                    doc_intro_loader[doc_id + "\t" + name_part] = intro_list[i]
                doc_intro_loader[doc_id + "\t" + name] = intro_list[i]


def get_full_name(document_id, name):
    return name_loader.get(document_id + "\t" + name, None)


def get_doc_intro(document_id, name):
    return doc_intro_loader.get(document_id + "\t" + name, None)


def find_confident_entity(mention):
    entities = get_entities(mention.lower())
    for entity, stats in entities.items():
        if stats[1] > 0.98:
            return entity
    return None


def get_full_name_doc_intro(document_id, entity_text, default_context):
    if document_id is not None and document_id.startswith("wiki_"):
        info = get_document(document_id)
        parts = info.split("\t")
        title = typical_name(parts[3])
        if possible_name_match(entity_text, title):
            intro = split_sentences(parts[4])[0]
            ent_types = find_type_list([[entity_text, intro]])[0]
            return title, get_text_with_fullname(intro, entity_text, ent_types)
    entity = find_confident_entity(entity_text)
    if entity is not None:
        # Check for confident In-KB entities
        title_intro = get_title_intro(entity)
        if title_intro is not None:
            title_intro_parts = title_intro.split("\t")
            ent_types = find_type_list([[entity_text, title_intro_parts[1]]])[0]
            return title_intro_parts[0], get_text_with_fullname(title_intro_parts[1], entity_text, ent_types)

    if document_id is None:
        return entity_text, default_context
    full_name = get_full_name(document_id, entity_text)
    doc_intro = get_doc_intro(document_id, entity_text)
    answer_context = default_context
    if " " in entity_text:
        # Long name
        if doc_intro is not None:
            answer_context = doc_intro
    else:
        # Short name
        if full_name is not None:
            entity_text = full_name
            answer_context = doc_intro
    return entity_text, answer_context


if __name__ == "__main__":
    news_list = ["news_5\t2018-11-06T08:00:00.000+0100\thttp://www.nzherald.co.nz/entertainment/news/article.cfm?c_id=1501119&objectid=11590511&ref=rss\tWhy Sacha Baron Cohen has 'no desire' to win an Oscar\tWhy Sacha Baron Cohen has 'no desire' to win an Oscar 7:00 PM Tuesday Feb 16, 2016 Not saved Celebrity Sacha Baron Cohen joked that including two black actors in his new film means he won't win an Oscar. Photo / Getty Sacha Baron Cohen has joked he cast \"two black actors\" in his new film Grimsby because he has \"no desire to win an Oscar\". The 44-year-old British actor co-wrote and stars in the spoof spy comedy movie and has waded into the Academy Awards diversity row by comically claiming Precious actress Gabourey Sidibe and Spooks: The Greater Good star David Harewood only appear in the movie to ensure it is snubbed in the Oscars nominations next year. Speaking on the red carpet at the BAFTA Awards at The Royal Opera House in London on Sunday night, Sacha - who was accompanied to the ceremony by his actress wife Isla Fisher - quipped: \"I've just got to say, I'm coming out with a new film called Grimsby and we have no desire to win an Oscar, which is why we have cast two black actors in the lead roles.\" Sacha's comments followed the recent controversy surrounding the 2016 Oscar nominations, which had very few actors of colour listed. Hollywood heavyweights such as Will Smith and his wife Jada Pinkett Smith are skipping this year's ceremony on February 28, in protest at the lack of diversity, and rapper Snoop Dogg says he won't be tuning in. Despite his Oscars joke, Sacha - who was raised in the Jewish faith - doesn't believe the Academy is in any way racist. More from Spy:  \u00a2 What a tease! TV3 fakes contestants in new Bachelor promo He explained: \"I think the problem is the actual makeup of the films and the production staff and the directors and the actors are generally white. And I think there needs to be greater diversity here (in the UK) and in America. \"So I don't think it's that the members of the Academy are actually racist I think they aren't presented with enough films of diversity and I think it's not just African Americans I think it is Latino as well.\" - Bang! Showbiz\n",
                 "news_1463841\t2018-11-20T14:59:59.000+0100\thttps://www.khaleejtimes.com/sport/cricket/steve-smith-david-warner-to-serve-out-bans-in-full\tSteve Smith, David Warner to serve out bans in full\tSteve Smith, David Warner to serve out bans in full Reuters/Sydney Filed on November 20, 2018 | Last updated on November 20, 2018 at 03.02 pm Share More > Vote Steve Smith (left), David Warner (centre) and Cameron Bancroft were handed bans over ball-tampering issue in March. (AFP) The players' union contested that the bans were unduly harsh, and had pushed for the players to be able to resume cricket immediately. Steve Smith and David Warner will serve out their one-year bans in full after a review of the punishments by the board of Cricket Australia (CA), the governing body said on Tuesday. Former Test captain Smith and his vice-captain Warner were handed the bans from international and state cricket after the ball-tampering scandal that rocked Australian Cricket in March this year. Batsman Cameron Bancroft was also banned for nine months for his role in trying to alter the condition of the ball during a Test match against South Africa in Cape Town. He will be able to return to representative cricket at the end of December. The players' union, the Australian Cricketers' Association (ACA), have always contested the bans were unduly harsh and had pushed for all three to be able to resume first class cricket immediately. \"The Cricket Australia Board has carefully considered all elements of the ACA submission and has determined that it is not appropriate to make any changes to the sanctions handed down to the three players,\" CA's chairman Earl Eddings said in a statement. Calls for the bans to be looked at again intensified after an independent review into CA last month said the governing body had contributed to the ball-tampering scandal by fostering a \"win without counting the costs\" culture. That review led to the resignation of CA chairman David Peever, who had forcefully maintained that the players should see out the full terms of their suspensions. \"The original decision of the board to sanction the players was determined after rigorous discussion and consideration,\" Eddings, Peever's temporary replacement, added. \"CA maintains that both the length and nature of the sanctions remain an appropriate response in light of the considerable impact on the reputation of Australian cricket, here and abroad.\" Share More > Vote Click/tap here to subscribe to Khaleej Times news alerts on WhatsApp. Make sure you save the phone number under Contacts on your phone for uninterrupted service. ERROR: Macro /ads/dfp-ad-article-new is missing! MORE FROM Sports\n",
                 "wiki_2186219\tN/A\thttps://en.wikipedia.org/wiki/Dominic_Chappell\tDominic Chappell\tDominic Joseph Andrew Chappell (born 28 November 1966) is a British businessman and former racing driver, who has been declared bankrupt on three occasions. In 2015, his company, Retail Acquisitions Ltd, purchased the now collapsed retail chain British Home Stores from Philip Green for just \u00c3 \u00a31 GBP and a \u00c3 \u00a310,000,000 equity injection into BHS Group Ltd. 13 months later the company was placed into administration resulting in the closure of 164 stores and the loss of 11,000 jobs. Early life. Chappell was born in Sunbury on Thames, Surrey in 1966. He was educated at Millfield School in Somerset. Motor racing. Chappell competed from 1986 to 1999 including British Formula Ford 2000, and British F3 in 1990, finishing runner up in the Class B Championship. Chappell competed in the 24 Hours of Le Mans race in the GT1 class in 1994 (not classified), 1995 (did not finish) and 1996 (did not finish), and entered in the GT2 class in 1997 but failed to qualify. Chappell launched the Interactive Sportscar Championship in the UK in 2001. The series folded after one race, leaving almost everybody unpaid, despite promises of payment. Outside Motorsport. In August 2016, Chappell was disqualified from holding a driving licence for six months and fined after pleading guilty to driving at over 63mph in a 40mph zone in Andover, Hampshire. Business career. Chappell has been a director of various companies, and has been made bankrupt two times and entered into an individual voluntary arrangement once. He was involved in the Island Harbour Marina development on the Isle of Wight. It was reported in 2015 that Chappell, with the backing of investors, became the 90% owner of Retail Acquisitions, the firm that acquired British Home Stores (BHS) from Sir Philip Green for \u00c3 \u00a31. It subsequently transpired that instead of injecting new capital into the cash-strapped company as agreed with Arcadia, Chappell extracted \u00c3 \u00a31,789,250 within three months of acquiring control of BHS. During the 13-month period he controlled BHS, Chappell by his own admission, extracted a total of \u00c3 \u00a32,627,643 from BHS. On 26 April 2016, it was reported that when it became likely that BHS would be going into receivership Chappell had moved \u00c3 \u00a31.5 million from the firm to a company owned by a friend who was also a fellow board member of Retail Acquisitions. The sum had been later refunded at the request of BHS' chief executive Darren Topp (less \u00c3 \u00a350,000 bank transaction fees). Just days after putting BHS into liquidation, and with its \u00c3 \u00a3571m pension deficit absorbed by the UK government's Pension Protection Fund, Chappell was said to be considering re-purchasing some parts of the firm. Reporting on this development, the BBC's Business editor Simon Jack noted: \"Sources at BHS treated the announcement with bewilderment. Other very senior retail sources used more colourful language. His credibility has taken a very serious knock. The details that have emerged about Dominic Chappell and his fellow directors' extraction of millions in professional fees has attracted widespread criticism\". On 2 September 2016, another Chappell owned company, Swiss Rock plc was put into liquidation. The Statement of Affairs included unpaid VAT debts of \u00c3 \u00a3365,000 and outstanding Corporation Tax of \u00c3 \u00a3197,306. \n",
                 "wiki_590317\tN/A\thttps://en.wikipedia.org/wiki/Michael_Jordan_(American_football)\tMichael Jordan (American football)\tMichael Jordan (born October 21, 1992) is an American football cornerback for the Cleveland Browns of the National Football League (NFL). He played college football at Missouri Western State. He signed with the Los Angeles Rams as an undrafted free agent in 2016. Professional career. Los Angeles Rams. Jordan was signed as an undrafted free agent with the Los Angeles Rams after going undrafted in the 2016 NFL Draft. On September 3, 2016, he was waived by the Rams as part of final roster cuts. The next day, he was signed to the Rams' practice squad. He was promoted to the active roster on November 22, 2016. On September 2, 2017, Jordan was waived by the Rams. Cleveland Browns. On September 3, 2017, Jordan was claimed off waivers by the Cleveland Browns.\n",
                 "news_694037\t2017-10-05T11:41:42.000+0200\thttp://www.telegraph.co.uk/news/2017/10/05/terminally-ill-man-loses-high-court-challenge-against-law-assisted/\tTerminally-ill man loses High Court challenge against the law on assisted dying\tTelegraph Reporters 5 October 2017  \u00a2 10:41am A man who is terminally ill with motor neurone disease has lost his High Court challenge against the law on \u00a0 assisted dying Retired college lecturer \u00a0Noel \u00a0Conway \u00a0took his case to the Court of Appeal after he was refused permission to bring a judicial review over the blanket ban on providing a person with assistance to die. MPs debated changing the law in September 2015 but the proposals were voted down by a 212 majority . \u00a0 Mr Conway \u00a0wanted \u00a0a declaration that the Suicide Act 1961 is incompatible with Article 8, which relates to respect for private and family life, and Article 14, which protects from discrimination. Noel Conway with his wife Carol Credit: Annabel Moeller/Dignity in Dying /PA But Lord Justice Sales, Mrs Justice Whipple and Mr Justice Garnham rejected his case. Campaigners against assisted dying warned that the case could \"usurp \u00a0the democratic will of Parliament\". \u00a0 The case was opposed by the Secretary of State for Justice, with Humanists UK, Care Not Killing and Not Dead Yet UK also making submissions. James Strachan QC said that it was inappropriate for the courts to interfere with Parliament's legitimate decision on the \"sensitive moral, social and ethical issue\" raised by the case. Assisted Dying \u00a0 It is the first challenge to the existing law since the case of Tony Nicklinson, who suffered from paralysis after a stroke. That was ultimately dismissed in June 2014 by the Supreme Court, which said it was important that Parliament debated the issues before any decision was made by the courts. After debates in the House of Commons and the House of Lords, Parliament decided, at least for the moment, not to provide for legislative exceptions to the 1961 Act. Mr Conway's counsel, Richard Gordon QC, said it was a \"very narrowly focused\" case which sought only to challenge the blanket ban on assisted dying for a relatively small category, which included Mr Conway. This covered adults over 18 who were diagnosed with a terminal illness with a prognosis of six months or less, who had mental capacity, who had made a \"voluntary, clear, settled and informed\" decision to receive assistance to die, and who retained the ability to undertake the final act required to bring about their death. The evidence demonstrated that a practical scheme, including suitable safeguards, could be devised for those in Mr Conway's narrowly defined group who could safely be provided with assistance to die without affecting the legitimate aim of the protection of the weak and vulnerable, said counsel. Mr Strachan said that Mr Conway's \"tragic and distressing\" circumstances could only evoke the deepest sympathy. But, the circumstances which led the Supreme Court to refuse such a declaration had not changed so as to make a different outcome justified. \"Parliament has very recently decided to reject exactly the sort of change to the existing law which the claimant is relying upon in these proceedings. \"The issue continues to be subject to scrutiny by Parliament as demonstrated by the recent debates in both the House of Commons and the House of Lords and by the anticipated reintroduction of an Assisted Dying Bill in the House of Lords for the 2017/2019 parliamentary session.\" Related Topics\n",
                 "wiki_2867525\tN/A\thttps://en.wikipedia.org/wiki/Olaf_Scholz\tOlaf Scholz	Olaf Scholz (; born , in OsnabrÃ ¼ck) is a German politician of the Social Democratic Party of Germany and First Mayor of Hamburg since 7 March 2011. Political career. A former Vice President of the International Union of Socialist Youth, Scholz represented Hamburg Altona in the Bundestag between 1998 and 2001 as well as between 2002 and 2011. From May to October 2001, he was Minister of the Interior \"(Innensenator)\" of Hamburg under First Mayor Ortwin Runde and from 2002 to 2004 he was Secretary-General of the SPD; he resigned from that office when Chancellor Gerhard SchrÃ ¶der, facing disaffection within his own party and hampered by persistently low public approval ratings, announced that he would step down as chairman of the Social Democratic Party. Scholz served as the SPD parliamentary groupÃ¢  s spokesperson on the inquiry committee investigating the German Visa Affair in 2005. Following the federal elections later that year, he served as First Parliamentary Secretary of the SPD parliamentary group. In this capacity, he worked closely with the CDU parliamentary floor manager Norbert RÃ ¶ttgen to manage and defend the grand coalition led by Chancellor Angela Merkel in parliament. He also served as member of the Parliamentary Control Panel, which provides parliamentary oversight of GermanyÃ¢  s intelligence services BND, MAD and BfV. In addition, he was a member of the parliamentary body in charge of appointing judges to the Highest Courts of Justice, namely the Federal Court of Justice (BGH), the Federal Administrative Court (BVerwG), the Federal Fiscal Court (BFH), the Federal Labour Court (BAG), and the Federal Social Court (BSG). Scholz succeeded Franz MÃ ¼ntefering as Federal Minister of Labour and Social Affairs in the first cabinet of Chancellor Angela Merkel, when MÃ ¼ntefering left office in November 2007. Following the 2009 elections, Scholz served as deputy chairman of the SPD parliamentary group. Between 2009 and 2011, he served on the groupÃ¢  s Afghanistan/Pakistan Task Force. In 2010 he also participated in the annual Bilderberg Meeting in Sitges, Spain. First Mayor of Hamburg, 2011-present. On 20 February 2011 the Social Democrats led by Scholz won the 2011 Hamburg state election with 48.3% of the votes, resulting in 62 out of 121 seats in the Hamburg Parliament. Scholz resigned as a member of the seventeenth Bundestag on 11 March 2011 shortly after his election as First Mayor; Dorothee Stapelfeldt, also a Social Democrat, was made Deputy First Mayor. On June 7, 2011, Scholz attended the state dinner hosted by President Barack Obama in honor of Chancellor Angela Merkel at the White House. As host of HamburgÃ¢  s annual St. MatthewÃ¢  s Day banquet for the cityÃ¢  s civic and business leaders, he has invited several high-ranking guests of honour to the city, including Prime Minister Jean-Marc Ayrault of France (2013), Prime Minister David Cameron of the United Kingdom (2016), and Prime Minister Justin Trudeau of Canada (2017). In 2013, Scholz opposed a public initiative aiming at a complete buyback of energy grids Hamburg had sold to utilities Vattenfall Europe AG and E.ON decades before; he argued this would overburden the city, whose debt pile stood at more than 20 billion euros at the time. Scholz participated in the exploratory talks between the CDU, CSU and SPD parties to form a coalition government following the 2013 federal elections. In the subsequent negotiations, he led the SPD delegation in the financial policy working group; his co-chair from the CDU/CSU was Finance Minister Wolfgang SchÃ ¤uble. Alongside fellow Social Democrats JÃ ¶rg Asmussen and Thomas Oppermann, Scholz was considered a possible successor to SchÃ ¤uble in the post of finance minister at the time. In a paper compiled in late 2014, Scholz and SchÃ ¤uble proposed redirecting revenue from the so-called solidarity surcharge on income and corporate tax (\"SolidaritÃ ¤tszuschlag\") to subsidize the federal statesÃ¢   interest payments. Since January 2015, he has been serving as Commissioner of the Federal Republic of Germany for Cultural Affairs under the Treaty on Franco-German Cooperation. Under ScholzÃ¢   leadership, the Social Democrats handily won the 2015 state elections in Hamburg, receiving around 47 percent of the vote. His coalition government with the Green Party Ã¢   with Green leader Katharina Fegebank serving as Deputy First Mayor Ã¢   was sworn in on 15 April 2015. In 2015, Scholz led HamburgÃ¢  s bid to host the 2024 Summer Olympics at an estimated budget of 11.2 billion euros ($12.6 billion), competing against Los Angeles, Paris, Rome and Budapest; the citizens of Hamburg, however, later rejected the candidacy in a referendum, with more than half voting against the project. In 2015, Scholz Ã¢   alongside Minister-President Torsten Albig of Schleswig-Holstein Ã¢   negotiated a restructuring deal with the European Commission that allowed the German regional lender HSH Nordbank to offload 6.2 billion euros in troubled assets Ã¢   mainly non-performing ship loans Ã¢   onto its government majority owners and avoid being shut down, saving around 2,500 jobs. Controversy. When \"Die Tageszeitung\" interviewed Scholz, then serving as secretary general of the ruling SPD, during a 2003 party conference, he later demanded massive changes and threatened to pull the entire piece. When the editors said they would go ahead and publish it without authorization, Scholz warned that the paper would be excluded from all future SPD background talks. The newspaper published the interview with all of Scholz's answers blacked, and the paper's editor-in-chief Bascha Mika condemned his behavior as a \"betrayal of the claim to a free press, a betrayal of the journalist's self-definition, a betrayal of the reader.\" Personal life. Olaf Scholz is married with Britta Ernst (born 1961); they have no children. She is also a politician (SPD).",
                 "wiki_2394815\tN/A\thttps://en.wikipedia.org/wiki/Trevor_Davis\tTrevor Davis\tTrevor Lee Davis (born July 4, 1993) is an American football wide receiver for the Green Bay Packers of the National Football League (NFL). He played college football at California. Davis was drafted by the Packers in the fifth round of the 2016 NFL Draft. Early years. Davis attended Alhambra High School in Martinez, California. His football team won a conference title with Davis totaling 27 catches for 504 yards with an 11-2 record in his junior year. As a senior, he hauled in 43 catches for 876 yards and nine touchdowns. Davis also participated in track and field competing in the long jump, triple jump and sprint events. He would go onto set school records in the 100 (10.72) and 200 (22.15) meters and the long jump (23Ã¢   6Ã¢  ). In an interview with ESPN Wisconsin Radio in December 2016, Davis explained that his favorite NFL team growing up was the Philadelphia Eagles, due to the fact that Donovan McNabb was his second cousin. He also said that he was able to talk to McNabb when the Green Bay Packers played at Philadelphia during his rookie season. College career. Hawaii (2011Ã¢  2012). In 2011, Davis started six games for the Rainbow Warriors. He made his first career start at Idaho on October 29, where he finished with four catches for 32 yards. Davis had a career-high seven catches for 81 yards and two touchdowns against Tulane and finished the season with six catches for a career-high 111 yards and one touchdown against BYU. He totaled 28 receptions for 336 yards and three touchdowns over his freshman year. As a sophomore, Davis had statistical drop where he would have 17 receptions for 235 yards and two touchdowns for the entire season. He ultimately decided to transfer from Hawaii after Greg McMackin was replaced by Norm Chow. California (2013Ã¢  2015). After his sophomore season, he transferred to California. At California, Davis was one of the main targets for 2016 number-one pick Jared Goff. In his final two seasons, he racked up 64 receptions for 971 yards and seven touchdowns. He also started returning kicks at California, returning two kicks for touchdowns in his junior year, leading the NCAA. Professional career. Davis earned an invite to participate in the NFL Scouting Combine, although prior to the combine he was not considered to be on the minds of many NFL analysts. Davis ranked in the top 4 out of all wide receivers at the 2016 NFL Scouting Combine in the 40-yard dash and vertical jump. Davis was selected in the fifth round (163rd overall) by the Green Bay Packers in the 2016 NFL Draft. When asked about his speed the Packers director of football operations Eliot Wolf said, \"That was one of the main attractions, definitely.\" On May 6, 2016, he signed a contract with the Packers. In Week 8 against the Falcons, Davis caught his first pass on a six-yard pass from Aaron Rodgers. Later that game he caught his first career touchdown on a nine-yard pass from Rodgers. He finished the game with three receptions for 24 yards, his total for the whole season."]
    add_names(news_list)
    print(get_full_name_doc_intro("wiki_2394815", "Davis", ""))
